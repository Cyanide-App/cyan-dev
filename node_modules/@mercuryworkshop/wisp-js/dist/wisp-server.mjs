var t={512:function(t){!function(e){const s="(0?\\d+|0x[a-f0-9]+)",r={fourOctet:new RegExp(`^${s}\\.${s}\\.${s}\\.${s}$`,"i"),threeOctet:new RegExp(`^${s}\\.${s}\\.${s}$`,"i"),twoOctet:new RegExp(`^${s}\\.${s}$`,"i"),longValue:new RegExp(`^${s}$`,"i")},n=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${s}\\.${s}\\.${s}\\.${s}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${s}\\.${s}\\.${s}\\.${s}(${o})?$`,"i")};function l(t,e){if(t.indexOf("::")!==t.lastIndexOf("::"))return null;let s,r,n=0,i=-1,o=(t.match(c.zoneIndex)||[])[0];for(o&&(o=o.substring(1),t=t.replace(/%.+$/,""));(i=t.indexOf(":",i+1))>=0;)n++;if("::"===t.substr(0,2)&&n--,"::"===t.substr(-2,2)&&n--,n>e)return null;for(r=e-n,s=":";r--;)s+="0:";return":"===(t=t.replace("::",s))[0]&&(t=t.slice(1)),":"===t[t.length-1]&&(t=t.slice(0,-1)),{parts:e=function(){const e=t.split(":"),s=[];for(let t=0;t<e.length;t++)s.push(parseInt(e[t],16));return s}(),zoneId:o}}function h(t,e,s,r){if(t.length!==e.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let n,i=0;for(;r>0;){if(n=s-r,n<0&&(n=0),t[i]>>n!=e[i]>>n)return!1;r-=s,i+=1}return!0}function u(t){if(i.test(t))return parseInt(t,16);if("0"===t[0]&&!isNaN(parseInt(t[1],10))){if(n.test(t))return parseInt(t,8);throw new Error(`ipaddr: cannot parse ${t} as octal`)}return parseInt(t,10)}function p(t,e){for(;t.length<e;)t=`0${t}`;return t}const d={};d.IPv4=function(){function t(t){if(4!==t.length)throw new Error("ipaddr: ipv4 octet count should be 4");let e,s;for(e=0;e<t.length;e++)if(s=t[e],!(0<=s&&s<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=t}return t.prototype.SpecialRanges={unspecified:[[new t([0,0,0,0]),8]],broadcast:[[new t([255,255,255,255]),32]],multicast:[[new t([224,0,0,0]),4]],linkLocal:[[new t([169,254,0,0]),16]],loopback:[[new t([127,0,0,0]),8]],carrierGradeNat:[[new t([100,64,0,0]),10]],private:[[new t([10,0,0,0]),8],[new t([172,16,0,0]),12],[new t([192,168,0,0]),16]],reserved:[[new t([192,0,0,0]),24],[new t([192,0,2,0]),24],[new t([192,88,99,0]),24],[new t([198,18,0,0]),15],[new t([198,51,100,0]),24],[new t([203,0,113,0]),24],[new t([240,0,0,0]),4]],as112:[[new t([192,175,48,0]),24],[new t([192,31,196,0]),24]],amt:[[new t([192,52,193,0]),24]]},t.prototype.kind=function(){return"ipv4"},t.prototype.match=function(t,e){let s;if(void 0===e&&(s=t,t=s[0],e=s[1]),"ipv4"!==t.kind())throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return h(this.octets,t.octets,8,e)},t.prototype.prefixLengthFromSubnetMask=function(){let t=0,e=!1;const s={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let r,n,i;for(r=3;r>=0;r-=1){if(n=this.octets[r],!(n in s))return null;if(i=s[n],e&&0!==i)return null;8!==i&&(e=!0),t+=i}return 32-t},t.prototype.range=function(){return d.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){return this.octets.slice(0)},t.prototype.toIPv4MappedAddress=function(){return d.IPv6.parse(`::ffff:${this.toString()}`)},t.prototype.toNormalizedString=function(){return this.toString()},t.prototype.toString=function(){return this.octets.join(".")},t}(),d.IPv4.broadcastAddressFromCIDR=function(t){try{const e=this.parseCIDR(t),s=e[0].toByteArray(),r=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[];let i=0;for(;i<4;)n.push(parseInt(s[i],10)|255^parseInt(r[i],10)),i++;return new this(n)}catch(t){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},d.IPv4.isIPv4=function(t){return null!==this.parser(t)},d.IPv4.isValid=function(t){try{return new this(this.parser(t)),!0}catch(t){return!1}},d.IPv4.isValidCIDR=function(t){try{return this.parseCIDR(t),!0}catch(t){return!1}},d.IPv4.isValidFourPartDecimal=function(t){return!(!d.IPv4.isValid(t)||!t.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},d.IPv4.networkAddressFromCIDR=function(t){let e,s,r,n,i;try{for(e=this.parseCIDR(t),r=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[],s=0;s<4;)n.push(parseInt(r[s],10)&parseInt(i[s],10)),s++;return new this(n)}catch(t){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},d.IPv4.parse=function(t){const e=this.parser(t);if(null===e)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(e)},d.IPv4.parseCIDR=function(t){let e;if(e=t.match(/^(.+)\/(\d+)$/)){const t=parseInt(e[2]);if(t>=0&&t<=32){const s=[this.parse(e[1]),t];return Object.defineProperty(s,"toString",{value:function(){return this.join("/")}}),s}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},d.IPv4.parser=function(t){let e,s,n;if(e=t.match(r.fourOctet))return function(){const t=e.slice(1,6),r=[];for(let e=0;e<t.length;e++)s=t[e],r.push(u(s));return r}();if(e=t.match(r.longValue)){if(n=u(e[1]),n>4294967295||n<0)throw new Error("ipaddr: address outside defined range");return function(){const t=[];let e;for(e=0;e<=24;e+=8)t.push(n>>e&255);return t}().reverse()}return(e=t.match(r.twoOctet))?function(){const t=e.slice(1,4),s=[];if(n=u(t[1]),n>16777215||n<0)throw new Error("ipaddr: address outside defined range");return s.push(u(t[0])),s.push(n>>16&255),s.push(n>>8&255),s.push(255&n),s}():(e=t.match(r.threeOctet))?function(){const t=e.slice(1,5),s=[];if(n=u(t[2]),n>65535||n<0)throw new Error("ipaddr: address outside defined range");return s.push(u(t[0])),s.push(u(t[1])),s.push(n>>8&255),s.push(255&n),s}():null},d.IPv4.subnetMaskFromPrefixLength=function(t){if((t=parseInt(t))<0||t>32)throw new Error("ipaddr: invalid IPv4 prefix length");const e=[0,0,0,0];let s=0;const r=Math.floor(t/8);for(;s<r;)e[s]=255,s++;return r<4&&(e[r]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},d.IPv6=function(){function t(t,e){let s,r;if(16===t.length)for(this.parts=[],s=0;s<=14;s+=2)this.parts.push(t[s]<<8|t[s+1]);else{if(8!==t.length)throw new Error("ipaddr: ipv6 part count should be 8 or 16");this.parts=t}for(s=0;s<this.parts.length;s++)if(r=this.parts[s],!(0<=r&&r<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");e&&(this.zoneId=e)}return t.prototype.SpecialRanges={unspecified:[new t([0,0,0,0,0,0,0,0]),128],linkLocal:[new t([65152,0,0,0,0,0,0,0]),10],multicast:[new t([65280,0,0,0,0,0,0,0]),8],loopback:[new t([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new t([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new t([0,0,0,0,0,65535,0,0]),96],discard:[new t([256,0,0,0,0,0,0,0]),64],rfc6145:[new t([0,0,0,0,65535,0,0,0]),96],rfc6052:[new t([100,65435,0,0,0,0,0,0]),96],"6to4":[new t([8194,0,0,0,0,0,0,0]),16],teredo:[new t([8193,0,0,0,0,0,0,0]),32],benchmarking:[new t([8193,2,0,0,0,0,0,0]),48],amt:[new t([8193,3,0,0,0,0,0,0]),32],as112v6:[[new t([8193,4,274,0,0,0,0,0]),48],[new t([9760,79,32768,0,0,0,0,0]),48]],deprecated:[new t([8193,16,0,0,0,0,0,0]),28],orchid2:[new t([8193,32,0,0,0,0,0,0]),28],droneRemoteIdProtocolEntityTags:[new t([8193,48,0,0,0,0,0,0]),28],reserved:[[new t([8193,0,0,0,0,0,0,0]),23],[new t([8193,3512,0,0,0,0,0,0]),32]]},t.prototype.isIPv4MappedAddress=function(){return"ipv4Mapped"===this.range()},t.prototype.kind=function(){return"ipv6"},t.prototype.match=function(t,e){let s;if(void 0===e&&(s=t,t=s[0],e=s[1]),"ipv6"!==t.kind())throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return h(this.parts,t.parts,16,e)},t.prototype.prefixLengthFromSubnetMask=function(){let t=0,e=!1;const s={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let r,n;for(let i=7;i>=0;i-=1){if(r=this.parts[i],!(r in s))return null;if(n=s[r],e&&0!==n)return null;16!==n&&(e=!0),t+=n}return 128-t},t.prototype.range=function(){return d.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){let t;const e=[],s=this.parts;for(let r=0;r<s.length;r++)t=s[r],e.push(t>>8),e.push(255&t);return e},t.prototype.toFixedLengthString=function(){const t=function(){const t=[];for(let e=0;e<this.parts.length;e++)t.push(p(this.parts[e].toString(16),4));return t}.call(this).join(":");let e="";return this.zoneId&&(e=`%${this.zoneId}`),t+e},t.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const t=this.parts.slice(-2),e=t[0],s=t[1];return new d.IPv4([e>>8,255&e,s>>8,255&s])},t.prototype.toNormalizedString=function(){const t=function(){const t=[];for(let e=0;e<this.parts.length;e++)t.push(this.parts[e].toString(16));return t}.call(this).join(":");let e="";return this.zoneId&&(e=`%${this.zoneId}`),t+e},t.prototype.toRFC5952String=function(){const t=/((^|:)(0(:|$)){2,})/g,e=this.toNormalizedString();let s,r=0,n=-1;for(;s=t.exec(e);)s[0].length>n&&(r=s.index,n=s[0].length);return n<0?e:`${e.substring(0,r)}::${e.substring(r+n)}`},t.prototype.toString=function(){return this.toRFC5952String()},t}(),d.IPv6.broadcastAddressFromCIDR=function(t){try{const e=this.parseCIDR(t),s=e[0].toByteArray(),r=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[];let i=0;for(;i<16;)n.push(parseInt(s[i],10)|255^parseInt(r[i],10)),i++;return new this(n)}catch(t){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${t})`)}},d.IPv6.isIPv6=function(t){return null!==this.parser(t)},d.IPv6.isValid=function(t){if("string"==typeof t&&-1===t.indexOf(":"))return!1;try{const e=this.parser(t);return new this(e.parts,e.zoneId),!0}catch(t){return!1}},d.IPv6.isValidCIDR=function(t){if("string"==typeof t&&-1===t.indexOf(":"))return!1;try{return this.parseCIDR(t),!0}catch(t){return!1}},d.IPv6.networkAddressFromCIDR=function(t){let e,s,r,n,i;try{for(e=this.parseCIDR(t),r=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[],s=0;s<16;)n.push(parseInt(r[s],10)&parseInt(i[s],10)),s++;return new this(n)}catch(t){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${t})`)}},d.IPv6.parse=function(t){const e=this.parser(t);if(null===e.parts)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(e.parts,e.zoneId)},d.IPv6.parseCIDR=function(t){let e,s,r;if((s=t.match(/^(.+)\/(\d+)$/))&&(e=parseInt(s[2]),e>=0&&e<=128))return r=[this.parse(s[1]),e],Object.defineProperty(r,"toString",{value:function(){return this.join("/")}}),r;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},d.IPv6.parser=function(t){let e,s,r,n,i,o;if(r=t.match(c.deprecatedTransitional))return this.parser(`::ffff:${r[1]}`);if(c.native.test(t))return l(t,8);if((r=t.match(c.transitional))&&(o=r[6]||"",e=r[1],r[1].endsWith("::")||(e=e.slice(0,-1)),e=l(e+o,6),e.parts)){for(i=[parseInt(r[2]),parseInt(r[3]),parseInt(r[4]),parseInt(r[5])],s=0;s<i.length;s++)if(n=i[s],!(0<=n&&n<=255))return null;return e.parts.push(i[0]<<8|i[1]),e.parts.push(i[2]<<8|i[3]),{parts:e.parts,zoneId:e.zoneId}}return null},d.IPv6.subnetMaskFromPrefixLength=function(t){if((t=parseInt(t))<0||t>128)throw new Error("ipaddr: invalid IPv6 prefix length");const e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let s=0;const r=Math.floor(t/8);for(;s<r;)e[s]=255,s++;return r<16&&(e[r]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},d.fromByteArray=function(t){const e=t.length;if(4===e)return new d.IPv4(t);if(16===e)return new d.IPv6(t);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},d.isValid=function(t){return d.IPv6.isValid(t)||d.IPv4.isValid(t)},d.isValidCIDR=function(t){return d.IPv6.isValidCIDR(t)||d.IPv4.isValidCIDR(t)},d.parse=function(t){if(d.IPv6.isValid(t))return d.IPv6.parse(t);if(d.IPv4.isValid(t))return d.IPv4.parse(t);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},d.parseCIDR=function(t){try{return d.IPv6.parseCIDR(t)}catch(e){try{return d.IPv4.parseCIDR(t)}catch(t){throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},d.process=function(t){const e=this.parse(t);return"ipv6"===e.kind()&&e.isIPv4MappedAddress()?e.toIPv4Address():e},d.subnetMatch=function(t,e,s){let r,n,i,o;for(n in null==s&&(s="unicast"),e)if(Object.prototype.hasOwnProperty.call(e,n))for(i=e[n],!i[0]||i[0]instanceof Array||(i=[i]),r=0;r<i.length;r++)if(o=i[r],t.kind()===o[0].kind()&&t.match.apply(t,o))return n;return s},t.exports?t.exports=d:e.ipaddr=d}(this)}},e={};function s(r){var n=e[r];if(void 0!==n)return n.exports;var i=e[r]={exports:{}};return t[r].call(i.exports,i,i.exports,s),i.exports}s.d=(t,e)=>{for(var r in e)s.o(e,r)&&!s.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};(()=>{s.d(r,{logging:()=>t,packet:()=>e,server:()=>n});var t={};s.r(t),s.d(t,{DEBUG:()=>i,ERROR:()=>c,INFO:()=>o,NONE:()=>l,WARN:()=>a,debug:()=>d,error:()=>y,get_timestamp:()=>u,info:()=>f,log:()=>w,log_level:()=>h,set_level:()=>p,warn:()=>_});var e={};s.r(e),s.d(e,{ClosePayload:()=>C,ConnectPayload:()=>P,ContinuePayload:()=>z,DataPayload:()=>$,WispBuffer:()=>I,WispPacket:()=>b,close_reasons:()=>D,packet_classes:()=>x,packet_types:()=>E,stream_types:()=>R});var n={};s.r(n),s.d(n,{ServerConnection:()=>it,ServerStream:()=>nt,options:()=>S,parse_real_ip:()=>ct,routeRequest:()=>lt});const i=0,o=1,a=2,c=3,l=4;let h=o;function u(){let[t,e]=(new Date).toJSON().split("T");return t=t.replaceAll("-","/"),e=e.split(".")[0],`[${t} - ${e}]`}function p(t){h=t}function d(...t){h>i||console.debug(u()+" debug:",...t)}function f(...t){h>o||console.info(u()+" info:",...t)}function w(...t){h>o||console.log(u()+" log:",...t)}function _(...t){h>a||console.warn(u()+" warn:",...t)}function y(...t){h>c||console.error(u()+" error:",...t)}const m=new TextEncoder,v=m.encode.bind(m),g=new TextDecoder,k=g.decode.bind(g);class I{constructor(t){if(t instanceof Uint8Array)this.from_array(t);else if("number"==typeof t)this.from_array(new Uint8Array(t));else{if("string"!=typeof t)throw console.trace(),"invalid data type passed to wisp buffer constructor";this.from_array(v(t))}}from_array(t){this.size=t.length,this.bytes=t,this.view=new DataView(t.buffer)}concat(t){let e=new I(this.size+t.size);return e.bytes.set(this.bytes,0),e.bytes.set(t.bytes,this.size),e}slice(t,e){let s=this.bytes.slice(t,e);return new I(s)}}class b{static min_size=5;constructor({type:t,stream_id:e,payload:s,payload_bytes:r}){this.type=t,this.stream_id=e,this.payload_bytes=r,this.payload=s}static parse(t){return new b({type:t.view.getUint8(0),stream_id:t.view.getUint32(1,!0),payload_bytes:t.slice(5)})}static parse_all(t){if(t.size<b.min_size)throw"packet too small";let e=b.parse(t),s=x[e.type];if(void 0===s)throw"invalid packet type";if(e.payload_bytes.size<s.size)throw"payload too small";return e.payload=s.parse(e.payload_bytes),e}serialize(){let t=new I(5);return t.view.setUint8(0,this.type),t.view.setUint32(1,this.stream_id,!0),t=t.concat(this.payload.serialize()),t}}class P{static min_size=3;static type=1;static name="CONNECT";constructor({stream_type:t,port:e,hostname:s}){this.stream_type=t,this.port=e,this.hostname=s}static parse(t){return new P({stream_type:t.view.getUint8(0),port:t.view.getUint16(1,!0),hostname:k(t.slice(3).bytes)})}serialize(){let t=new I(3);return t.view.setUint8(0,this.stream_type),t.view.setUint16(1,this.port,!0),t=t.concat(new I(this.hostname)),t}}class ${static min_size=0;static type=2;static name="DATA";constructor({data:t}){this.data=t}static parse(t){return new $({data:t})}serialize(){return this.data}}class z{static type=3;static name="CONTINUE";constructor({buffer_remaining:t}){this.buffer_remaining=t}static parse(t){return new z({buffer_remaining:t.view.getUint32(0,!0)})}serialize(){let t=new I(4);return t.view.setUint32(0,this.buffer_remaining,!0),t}}class C{static min_size=1;static type=4;static name="CLOSE";constructor({reason:t}){this.reason=t}static parse(t){return new C({reason:t.view.getUint8(0)})}serialize(){let t=new I(1);return t.view.setUint8(0,this.buffer_remaining),t}}const x=[void 0,P,$,z,C],E={CONNECT:1,DATA:2,CONTINUE:3,CLOSE:4},R={TCP:1,UDP:2},D={Unknown:1,Voluntary:2,NetworkError:3,InvalidInfo:65,UnreachableHost:66,NoResponse:67,ConnRefused:68,TransferTimeout:71,HostBlocked:72,ConnThrottled:73,ClientError:129},S={hostname_blacklist:null,hostname_whitelist:null,port_blacklist:null,port_whitelist:null,allow_direct_ip:!0,allow_private_ips:!1,allow_loopback_ips:!1,client_ip_blacklist:null,client_ip_whitelist:null,stream_limit_per_host:-1,stream_limit_total:-1,allow_udp_streams:!0,allow_tcp_streams:!0,dns_ttl:120,dns_method:"lookup",dns_servers:null,dns_result_order:"verbatim",parse_real_ip:!0,parse_real_ip_from:["127.0.0.1"]},A=globalThis.WebSocket,O=globalThis.crypto,T=null,U=null,N=null;class M{send_buffer_size=33554432;constructor(t){this.ws=t,this.connected=!1,this.data_queue=new q(1)}async connect(){await new Promise(((t,e)=>{this.ws.onopen=()=>{this.connected=!0,t()},this.ws.onmessage=t=>{this.data_queue.put(t.data)},this.ws.onclose=()=>{this.connected?this.data_queue.close():e()},this.ws.readyState===this.ws.OPEN&&(this.connected=!0,t())}))}async recv(){return await this.data_queue.get()}async send(t){if(this.ws.send(t),!(this.ws.bufferedAmount<=this.send_buffer_size))for(;!(this.ws.bufferedAmount<=this.send_buffer_size/2);)await new Promise((t=>{setTimeout(t,10)}))}close(t,e){this.ws.close(t,e),this.data_queue.close()}get buffered_amount(){return this.ws.bufferedAmount}}class q{constructor(t){this.max_size=t,this.queue=[],this.put_callbacks=[],this.get_callbacks=[]}put_now(t){this.queue.push(t),this.get_callbacks.shift()?.()}async put(t){this.size<=this.max_size||await new Promise((t=>{this.put_callbacks.push(t)})),this.put_now(t)}get_now(){return this.put_callbacks.shift()?.(),this.queue.shift()}async get(){return this.size>0||await new Promise((t=>{this.get_callbacks.push(t)})),this.get_now()}close(){let t;for(this.queue=[];t=this.get_callbacks.shift();)t();for(;t=this.put_callbacks.shift();)t()}get size(){return this.queue.length}}const B="undefined"!=typeof process,V=new Map;let j=null,F=null;function L(){if(!B)throw"not running on node.js"}function H(t){return F.resolve4(t)}function W(t){return F.resolve6(t)}async function G(t,e,s){try{return(await t(s))[0]}catch{return(await e(s))[0]}}async function J(t){if(!B)return t;let e=T.isIP(t);if(4===e||6===e)return t;let s=Date.now();for(let[t,e]of V)s-e.time>S.dns_ttl&&V.delete(t);let r,n=V.get(t);if(n){if(n.error)throw n.error;return n.address}try{r=await async function(t){if("lookup"===S.dns_method)return(await U.lookup(t,{order:S.dns_result_order})).address;if("resolve"===S.dns_method){if(F||(F=new U.Resolver),S.dns_servers!==j&&(d("Setting custom DNS servers to: "+S.dns_servers.join(", ")),F.setServers(S.dns_servers),j=S.dns_servers),"verbatim"===S.dns_result_order||"ipv6first"===S.dns_result_order)return await G(W,H,t);if("ipv4first"===S.dns_result_order)return await G(H,W,t);throw new Error("Invalid result order. options.dns_result_order must be either 'ipv6first', 'ipv4first', or 'verbatim'.")}if("function"==typeof S.dns_method)return await S.dns_method(t);throw new Error("Invalid DNS method. options.dns_method must either be 'lookup' or 'resolve'.")}(t),d(`Domain resolved: ${t} -> ${r}`),V.set(t,{time:Date.now(),address:r})}catch(e){throw V.set(t,{time:Date.now(),error:e}),e}return r}class K{constructor(t,e){L(),this.hostname=t,this.port=e,this.recv_buffer_size=128,this.socket=null,this.paused=!1,this.connected=!1,this.data_queue=new q(this.recv_buffer_size)}async connect(){let t=await J(this.hostname);await new Promise(((e,s)=>{this.socket=new T.Socket,this.socket.setNoDelay(!0),this.socket.on("connect",(()=>{this.connected=!0,e()})),this.socket.on("data",(t=>{this.data_queue.put(t)})),this.socket.on("close",(t=>{t&&!this.connected?s():this.data_queue.close(),this.socket=null})),this.socket.on("error",(t=>{_(`tcp stream to ${this.hostname} ended with error - ${t}`)})),this.socket.on("end",(()=>{this.socket&&(this.socket.destroy(),this.socket=null)})),this.socket.connect({host:t,port:this.port})}))}async recv(){return await this.data_queue.get()}async send(t){await new Promise((e=>{this.socket.write(t,e)}))}async close(){this.socket&&(this.socket.end(),this.socket=null)}pause(){this.data_queue.size>=this.data_queue.max_size&&(this.socket.pause(),this.paused=!0)}resume(){this.socket&&this.paused&&(this.socket.resume(),this.paused=!1)}}class Q{constructor(t,e){L(),this.hostname=t,this.port=e,this.connected=!1,this.recv_buffer_size=128,this.data_queue=new q(this.recv_buffer_size)}async connect(){let t=await J(this.hostname),e=T.isIP(t);await new Promise(((s,r)=>{this.socket=null.createSocket(6===e?"udp6":"udp4"),this.socket.on("connect",(()=>{s()})),this.socket.on("message",(t=>{this.data_queue.put(t)})),this.socket.on("error",(()=>{this.connected||r(),this.data_queue.close(),this.socket=null})),this.socket.connect(this.port,t)}))}async recv(){return await this.data_queue.get()}async send(t){this.socket.send(t)}async close(){this.socket&&(this.socket.close(),this.socket=null)}pause(){}resume(){}}var X=s(512);class Y extends Error{}function Z(t,e){return t===e||t[0]<=e&&t[1]>=e}function tt(t,e){let s=!1;for(let r of t)if(e(r)){s=!0;break}return!s}function et(t,e){for(let s of t)if(e(s))return!0;return!1}function st(t,e){return e.includes(t.range())}async function rt(t,e,s,r){if(!S.allow_tcp_streams&&e===R.TCP)return D.HostBlocked;if(!S.allow_udp_streams&&e===R.UDP)return D.HostBlocked;if(S.hostname_whitelist){if(tt(S.hostname_whitelist,(t=>t.test(s))))return D.HostBlocked}else if(S.hostname_blacklist&&et(S.hostname_blacklist,(t=>t.test(s))))return D.HostBlocked;if(S.port_whitelist){if(tt(S.port_whitelist,(t=>Z(t,r))))return D.HostBlocked}else if(S.port_blacklist&&et(S.port_blacklist,(t=>Z(t,r))))return D.HostBlocked;let n=s;if(X.isValid(s)){if(!S.allow_direct_ip)return D.HostBlocked}else try{n=await J(s)}catch{}if(function(t){if(!X.isValid(t))return!1;let e=X.parse(t);return!(S.allow_loopback_ips||!st(e,["loopback","unspecified"]))||!(S.allow_private_ips||!st(e,["broadcast","linkLocal","carrierGradeNat","private","reserved"]))}(n))return D.HostBlocked;if(!t)return 0;if(-1!==S.stream_limit_total&&Object.keys(t.streams).length>=S.stream_limit_total)return D.ConnThrottled;if(-1!==S.stream_limit_per_host){let e=0;for(let r of t.streams)r.socket.hostname===s&&e++;if(e>=S.stream_limit_per_host)return D.ConnThrottled}return 0}class nt{static buffer_size=128;constructor(t,e,s){this.stream_id=t,this.conn=e,this.socket=s,this.send_buffer=new q(nt.buffer_size),this.packets_sent=0}async setup(){await this.socket.connect(),this.tcp_to_ws().catch((t=>{y(`(${this.conn.conn_id}) a tcp/udp to ws task encountered an error - ${t}`),this.close()})),this.ws_to_tcp().catch((t=>{y(`(${this.conn.conn_id}) a ws to tcp/udp task encountered an error - ${t}`),this.close()}))}async tcp_to_ws(){for(;;){let t=await this.socket.recv();if(null==t)break;this.socket.pause();let e=new b({type:$.type,stream_id:this.stream_id,payload:new $({data:new I(new Uint8Array(t))})});await this.conn.ws.send(e.serialize().bytes),this.socket.resume()}await this.conn.close_stream(this.stream_id,D.Voluntary)}async ws_to_tcp(){for(;;){let t=await this.send_buffer.get();if(null==t)break;if(await this.socket.send(t),this.packets_sent++,this.packets_sent%(nt.buffer_size/2)!=0)continue;let e=new b({type:z.type,stream_id:this.stream_id,payload:new z({buffer_remaining:nt.buffer_size-this.send_buffer.size})});this.conn.ws.send(e.serialize().bytes)}await this.close()}async close(t=null){if(this.send_buffer.close(),this.socket.close(),null==t)return;let e=new b({type:C.type,stream_id:this.stream_id,payload:new C({reason:t})});await this.conn.ws.send(e.serialize().bytes)}async put_data(t){await this.send_buffer.put(t)}}class it{constructor(t,e,{TCPSocket:s,UDPSocket:r,ping_interval:n}={}){this.ws=new M(t),this.path=e,this.TCPSocket=s||K,this.UDPSocket=r||Q,this.ping_interval=n||30,this.ping_task=null,this.streams={},this.conn_id=O.randomUUID().split("-")[0]}async setup(){f(`setting up new wisp connection with id ${this.conn_id}`),await this.ws.connect();let t=new b({type:z.type,stream_id:0,payload:new z({buffer_remaining:nt.buffer_size})});await this.ws.send(t.serialize().bytes),"function"==typeof this.ws.ws.ping&&(this.ping_task=setInterval((()=>{d(`(${this.conn_id}) sending websocket ping`),this.ws.ws.ping()}),1e3*this.ping_interval))}create_stream(t,e,s,r){let n=new(e===R.TCP?this.TCPSocket:this.UDPSocket)(s,r),i=new nt(t,this,n);this.streams[t]=i,(async()=>{let n=await rt(this,e,s,r);if(n)return _(`(${this.conn_id}) refusing to create a stream to ${s}:${r}`),void await this.close_stream(t,n,!0);try{await i.setup()}catch(e){_(`(${this.conn_id}) creating a stream to ${s}:${r} failed - ${e}`),await this.close_stream(t,D.NetworkError)}})()}async close_stream(t,e=null,s=!1){let r=this.streams[t];null!=r&&(e&&!s&&f(`(${this.conn_id}) closing stream to ${r.socket.hostname} for reason ${e}`),await r.close(e),delete this.streams[t])}route_packet(t){let e=b.parse_all(t),s=this.streams[e.stream_id];if(null!=s||e.type!=$.type)if(e.type===P.type){let t=e.payload.stream_type===R.TCP?"TCP":"UDP";f(`(${this.conn_id}) opening new ${t} stream to ${e.payload.hostname}:${e.payload.port}`),this.create_stream(e.stream_id,e.payload.stream_type,e.payload.hostname.trim(),e.payload.port)}else e.type===$.type?s.put_data(e.payload.data.bytes):e.type==z.type?_(`(${this.conn_id}) client sent a CONTINUE packet, this should never be possible`):e.type==C.type&&this.close_stream(e.stream_id,e.reason);else _(`(${this.conn_id}) received a DATA packet for a stream which doesn't exist`)}async run(){for(;;){let t;if(t=await this.ws.recv(),null==t)break;try{this.route_packet(new I(new Uint8Array(t)))}catch(t){_(`(${this.conn_id}) routing a packet failed - ${t}`)}}for(let t of Object.keys(this.streams))await this.close_stream(t);clearInterval(this.ping_task),f(`(${this.conn_id}) wisp connection closed`)}}class ot{constructor(t,e){let[s,r]=e.split("/").pop().split(":");this.hostname=s.trim(),this.port=parseInt(r),this.ws=new M(t)}async setup(){if(await this.ws.connect(),0!==await rt(null,R.TCP,this.hostname,this.port))throw f(`Refusing to create a wsproxy connection to ${this.hostname}:${this.port}`),this.ws.close(),new Y;this.socket=new K(this.hostname,this.port),await this.socket.connect(),this.tcp_to_ws().catch((t=>{y(`a tcp to ws task (wsproxy) encountered an error - ${t}`)})),this.ws_to_tcp().catch((t=>{y(`a ws to tcp task (wsproxy) encountered an error - ${t}`)}))}async tcp_to_ws(){for(;;){let t=await this.socket.recv();if(null==t)break;this.socket.pause(),await this.ws.send(t),this.socket.resume()}await this.ws.close()}async ws_to_tcp(){for(;;){let t;if(t=await this.ws.recv(),null==t)break;await this.socket.send(t)}await this.socket.close()}}let at=null;function ct(t,e){if(S.parse_real_ip&&S.parse_real_ip_from.includes(e)){if(t["x-forwarded-for"])return t["x-forwarded-for"].split(",")[0].trim();if(t["x-real-ip"])return t["x-real-ip"]}return e}function lt(t,e,s,r={}){L(),t instanceof N.IncomingMessage?at.handleUpgrade(t,e,s,(e=>{ht(e,t.url,t,r)})):t instanceof A&&ht(ws,"/",{})}async function ht(t,e,s,r){let n=s.socket.address().address;f(`new connection on ${e} from ${ct(s.headers,n)}`);try{if(e.endsWith("/")){let s=new it(t,e,r);await s.setup(),await s.run()}else{let s=new ot(t,e,r);await s.setup()}}catch(e){if(t.close(),e instanceof Y)return;y("Uncaught server error:\n"+e.stack)}}B&&(at=new null({noServer:!0}))})();var n=r.logging,i=r.packet,o=r.server;export{n as logging,i as packet,o as server};