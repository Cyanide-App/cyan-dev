<!DOCTYPE html>
<html>
<head>
    <script>
    const PREFIX = "Balatro_vanilla_";
    const originalOpen = indexedDB.open;
    const originalDeleteDatabase = indexedDB.deleteDatabase;
    indexedDB.open = function(name, version) {
        const prefixedName = PREFIX + name;
        return version !== undefined ? originalOpen.call(this, prefixedName, version) : originalOpen.call(this, prefixedName);
    };
    indexedDB.deleteDatabase = function(name) {
        const prefixedName = PREFIX + name;
        return originalDeleteDatabase.call(this, prefixedName);
    };
    </script>
    <script src="love.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <title>Love.js</title>
    <style>
    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
    }
    body {
        width: 100vw;
        height: 100vh;
        margin: 0px;
    }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
    (async () => {
        async function loadModule() {
            const response = await fetch('module.js.zip');
            const zipBlob = await response.blob();
            // Use window.JSZip as the library is loaded from CDN
            const jszip = new window.JSZip();
            const zip = await jszip.loadAsync(zipBlob);
            const moduleFile = zip.file('module.js');
            if (moduleFile) {
                const moduleContent = await moduleFile.async('blob');
                const moduleUrl = URL.createObjectURL(moduleContent);
                const script = document.createElement('script');
                script.src = moduleUrl;
                document.body.appendChild(script);
                return new Promise(resolve => {
                    script.onload = () => {
                        console.log("module.js loaded from zip.");
                        resolve();
                    };
                });
            } else {
                throw new Error("module.js not found in zip file.");
            }
        }

        await loadModule();

        const d = await getSource();
        Module = {
            INITIAL_MEMORY: 2 ** 28,
            canvas: document.getElementById('canvas'),
            printErr: console.error,
            arguments: ["game.love"]
        };
        Module.preRun = [function() {
            Module.addRunDependency("fp game.love");
            var ptr = Module.getMemory(d.length);
            Module['HEAPU8'].set(d, ptr);
            Module.FS_createDataFile('/', "game.love", d, true, true, true);
            Module.removeRunDependency("fp game.love")
        }];
        Love(Module);
    })()
    </script>
</body>
</html>
